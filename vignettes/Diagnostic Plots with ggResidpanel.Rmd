---
title: "Overview of Creating Diagnostic Plots with ggResidpanel"
author: "Katherine Goode and Kathleen Rey"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
    toc: true
    theme: lumen
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center')
```

![](../images/gg_resid_sticker4.png){width=25%}

# Introduction to ggResidpanel

ggResidpanel provides a way to easily create and view diagnostic plots from models in R using ggplot2 graphics. The goal in creating the package was to allow a model to be passed to a function that returns a panel of diagnostic plots that can be viewed simultaneously. The panel allows the user to easily scan plots of interest to check for violations of model assumptions or lack of fit. The idea to portray the plots in a grid was motivated by the residual panel plots provided by SAS (version 9.4) procedures. In addition to being able to view the plots in a panel, ggResidpanel includes the ability to select which plots to include in the panel, ways to to adjust plot characteristics, and options to change the format of the figure. Furthermore, the package provides both static and interactive panels of plots and the ability to view diagnostic plots from multiple models in the same panel.

The package contains the following five functions. (Describe the model types accepted here.)

- `resid_panel`: Creates a panel of diagnostic plots of the residuals from a model (fit using a method currently accepted by the package)
- `resid_interact`: Creates an interactive panel of diagnostic plots of the residuals form a model (fit using a method currently accepted by the package)
- `resid_xpanel`: Creates a panel of diagnostic plots of the predictor variables (fit using a method currently accepted by the package)
- `resid_compare`: Creates a panel of diagnostic plots from multiple models (fit using a method currently accepted by the package)
- `resid_auxpanel`: Creates a panel of diagnostic plots for model types not included in the package

These functions are described in further detail below.

# Installing and Loading ggResidpanel

The package is currently only available on GitHub. The intention is to add the package to CRAN in the near future. For now, the following code can be used to install ggResidpanel using the devtools package.

```{r eval = FALSE}
# Download and install ggResidpanel from GitHub
devtools::install_github("goodekat/ggResidpanel")
```

To use the package in R, load the library into your R session with the following code.

```{r}
# Load the library
library(ggResidpanel)
```

# Functions in ggResidpanel

The functions will be explained below by fitting a model to the dataset `trees` included in R. The dataset contains information on the volume, girth, and height of 31 black cherry trees. The linear model below is fit to determine if their is a linear relationship between the volume of the tree given its height and girth.

```{r}
# Fit a linear model with a response variable of volume and predictor
# variables of height and girth
tree_model <- lm(Volume ~ Height + Girth, data = trees)
```

## <span style="color:blue">`resid_panel`</span>

The function `resid_panel` takes a model and returns a panel of diagnostic plots. The currently accepted models are 

  - models fit using the `lm` or `glm` functions in base R (which will be referred to as "lm" and "glm" models) or 
  - models fit using the `lmer` or `glmer` functions from either the lme4 or lmerTest package (which will be referred to as "lmer", "glmer", and "lmerTest" models). 
  
The most basic use of this function is to only include the model in the function. The code below shows the figure that is created if the `tree_model` is input into `resid_panel` with no other options specified. This produces a panel with the four plots of a residual plot, a normal quantile plot, an index plot, and a histogram of the residuals.

```{r}
# Apply the function resid_panel to the tree_model
resid_panel(tree_model)
```

The `plots` option in `resid_panel` allows the user to create a panel with a desired set of plots using the plots included in the package. The user can either specify a single plot, a vector of plots to include in the panel, or a prespecified panel of plots included in the package. 

### Individual Plots

There are nine individual plots included in the package. All plots are available to be used with "lm" and "glm" models, but only six of these plots are available to be used with "lmer", "glmer", and "lmerTest" models. Each of these plots are described in detail below.

(add a description of how to use each plot)

- `boxplot`: This creates a boxplot of the residuals.

```{r}
# Create a boxplot of the residuals
resid_panel(tree_model, plots = "boxplot")
```

- `cookd`: This creates a plot of the Cook's distance values versus the observation numbers. The blue dashed horizontal line is placed at 4/n where n is the number of observations used to fit the model. This plot is only available for "lm" and "glm" models.

```{r}
# Create a Cook's D plot
resid_panel(tree_model, plots = "cookd")
```

- `hist`: This creates a histogram of the residuals. The blue line is a density curve with a mean of zero and a standard deviation equal to the standard deviation of the residuals.

```{r}
# Create a histogram of the residuals
resid_panel(tree_model, plots = "hist")
```

- `index`: This creates a plot of the residuals versus the observation numbers. A solid blue horiztonal line through 0 is included.

```{r}
# Create an index plot of the residuals
resid_panel(tree_model, plots = "index")
```

- `lev`: This creates a plot of the standardized residuals versus the leverage values. A loess curve is overlaid as a red solid line, and a horizontal line through 0 and a vertical line through 0 are included as black dashed lines. Cook's distance can be computed as a function of leverage and standardized residuals as 
  $$(need \ to \ include).$$
The red dashed lines are Cook's distance contour lines for Cook's D values of 0.5 and 1. This plot is only available for "lm" and "glm" models.

```{r}
# Create a residuals vs. leverage plot
resid_panel(tree_model, plots = "lev")
```

- `ls`: This creates a location-scale plot of the residuals. It plots the square root of the absolute value of the standardized residuals on the y-axis and the predicted values on the x-axis. The predicted values are plotted on the original scale for "glm" and "glmer" models. A loess curve is overlaid as a red solid line. This plot is only available for "lm" and "glm" models.

```{r}
# Create a location-scale plot of the residuals
resid_panel(tree_model, plots = "ls")
```

- `qq`: This creates a normal quantile plot of residuals using the R package [qqplotr](https://cran.r-project.org/web/packages/qqplotr/index.html).

```{r}
# Create a normal quantile plot of the residuals
resid_panel(tree_model, plots = "qq")
```

- `resid`: This creates a plot of the residuals versus the predicted values. The predicted values are plotted on the original scale for glm and glmer models. A solid blue horiztonal line through 0 is included.

```{r}
# Create a residual plot
resid_panel(tree_model, plots = "resid")
```

- `yvp`: This creates a plot of the observed response variable values versus the predicted values from the model. Both response variable and predicted values are plotted on the original scale for "glm" and "glmer" models. The blue solid line is a 1-1 line, which is included for reference.

```{r}
# Create a plot of observed values vs. fitted values
resid_panel(tree_model, plots = "yvp")
```

### User Specified Panel

If the user wishes to select specific plots to include in the panel, the `plots` option allows for either one plot name or a vector of plot names to be specified. For example, one can specify `plots = "qq"` or `plots = c("resid", "qq")`.

```{r}
# An example of specifying a vector of plot names
resid_panel(tree_model, plots = c("resid", "qq"))
```

### Package Specified Panels

There are four prespecified panels options (`all`, `default`, `R`, and `SAS`).

- `all`: This creates a panel of all plot types included in the package that are available for the model type input into `resid_panel`. Note that "cookd", "ls", and "lev" are not available for "lmer", "lmerTest", and "glmer" models.

```{r}
resid_panel(tree_model, plots = "all")
```

- `default`: As expected, this is the default option, so it is not necessary to include this option in the code if this is the desired panel. This creates a panel with a residual plot, a normal quantile plot of the residuals, an index plot of the residuals, and a histogram of the residuals.

```{r}
resid_panel(tree_model, plots = "default")
```

- `R`: This option is designed to mimic the diagnostic plots created by applying the base R function `plot` to an "lm" or "glm" model. It creates a panel with a residual plot, a normal quantile plot of the residuals, a location-scale plot, and a residuals versus leverage plot. This was modeled after the plots shown in R if the plot() base function is applied to an lm model. This option can only be used with an lm or glm model.

```{r}
resid_panel(tree_model, plots = "R")
```

- `SAS`: This creates a panel with a residual plot, a normal quantile plot of the residuals, a histogram of the residuals, and a boxplot of the residuals. This was modeled after the residpanel option in proc mixed from SAS version 9.4.

```{r}
resid_panel(tree_model, plots = "SAS")
```

### Additional Input options

- `plots`: This allows the user to choose which plots to show in the panel. The default panel includes a residual plot, a normal quantile plot, an index plot, and a histogram of the residuals. The available plot options are descbied below in the section on "plot options".
- `type`: Type of residuals to use in the plot. If not specified, the default residual type for each model type is used. (See details for the options available.)
- `bins`:	Number of bins to use when creating a histogram of the residuals. Default is set to 30.
- `smoother`:	Indicates whether or not to include a smoother on the residual plot. Specify TRUE or FALSE. Default is set to FALSE.
- `qqline`:	Indicates whether to include a 1-1 line on the qq-plot. Specify TRUE or FALSE. Default is set to TRUE.
- `qqbands`: Indicates whether to include confidence bands on the qq-plot. Specify TRUE or FALSE. Default is set to FALSE.
- `scale`: Scales the size of the graphs in the panel. Takes values in (0,1].
- `theme`: ggplot2 theme to be used. Current options are "bw", "classic", and "grey" (or "gray"). Default is "bw".
- `axis.text.size`: Specifies the size of the text for the axis labels of all plots in the panel.
- `title.text.size`: Specifies the size of the text for the titles of all plots in the panel.
- `title.opt`: Indicates whether or not to include a title on the plots in the panel. Specify TRUE or FALSE. Default is set to TRUE.
- `nrow`: Sets the number of rows in the panel.

## <span style="color:blue">`resid_compare`</span>

## <span style="color:blue">`resid_interact`</span>

## <span style="color:blue">`resid_xpanel`</span>

## <span style="color:blue">`resid_auxpanel`</span>
