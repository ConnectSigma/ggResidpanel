---
title: "An Introduction to ggResidpanel"
author: "Katherine Goode and Kathleen Rey"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{An Introduction to ggResidpanel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", fig.align = "center",
                      message = FALSE, fig.height = 4.5, fig.width = 6.5)
```

```{r echo = FALSE}
# Load libraries
library(dplyr)
library(ggplot2)
```

<img align="right" width="135" height="150" src="https://goodekat.github.io/ggResidpanel/images/gg_resid_sticker4.png">

ggResidpanel is an R package that was developed with the intention of providing an easier way to both create and view diagnostic plots for models. The graphics are created using ggplot2, and interactive versions of the plots are rendered using plotly. This vignette provides a brief introduction to ggResidpanel with information on how to install the package and several examples. To learn more about ggResidpanel, you can read through the ggResidpanel Tutorial and User Manual, which contains the details for all of the functions in the package and demonstrates how to use them.

## Installation

ggResidpanel can be installed from GitHub using the command below. (ggResidpanel is not available on CRAN yet)

```{r, eval = FALSE}
devtools::install_github("goodekat/ggResidpanel")
```

Load the ggResidpanel library.

```{r}
# Load the library
library(ggResidpanel)
```

## Penguin Example

The dataset `penguins` is included in ggResidpanel, which contains information from a study done on emperor penguins. Emperor penguins are able to dive under the water for long periods of time. The scientists who conducted the study were interested in understanding how the heart rate of the penguins relates to the depth and duration of the dives. The study involved attaching a device to penguins that recorded the heart rate of the bird during a dive.

The structure of the data is shown below. It has four variables.
  
- heart rate of the penguin (beats per minute)
- depth of the dive (meters)
- duration of the dive (minutes)
- bird identification number associated with the dive 

There are 125 observations in the data and 9 birds. Thus, there are multiple observations per penguin.

```{r}
str(penguins)
```

The code below show the number of observations per penguin. Penguin number 6 has the least number of observations with only 6, and penguin number 1 has the most observations with 20.

```{r}
table(penguins$bird)
```

The figure below shows scatter plots for each penguin with the heart rate of a penguin versus the depth of the dive of the penguin. The points are colored by penguin. This shows that there appears to be a decrease in heart rate as the depth of the dive increases, but the manner in which the heart rate decreases varies between penguin.

```{r echo = FALSE}
penguins %>%
  mutate(bird = forcats::fct_recode(bird, 
                                    "Penguin 1" = "1", "Penguin 2" = "2",
                                    "Penguin 3" = "3", "Penguin 4" = "4", 
                                    "Penguin 5" = "5", "Penguin 6" = "6", 
                                    "Penguin 7" = "7", "Penguin 8" = "8", 
                                    "Penguin 9" = "9")) %>%
ggplot(aes(x = depth, y = heartrate, color = bird)) + 
  geom_point() + 
  facet_wrap( ~ bird) + 
  theme_bw() + 
  scale_color_manual(values = wesanderson::wes_palette("Zissou1", 9, 
                                                       type = "continuous")[1:9]) +
  labs(x = "Depth (m)", y = "Heart Rate (beats per minute)", color = "Penguin") + 
  theme(legend.position = "none")
```

The next figure shows the heart rate versus duration of the dive for each penguin. Again, the plots are colored by penguin. There is a clear decrease in heart rate as the duration of the dive increases. The trends are very similar between penguins.

```{r echo = FALSE}
penguins %>%
  mutate(bird = forcats::fct_recode(bird, 
                                    "Penguin 1" = "1", "Penguin 2" = "2",
                                    "Penguin 3" = "3", "Penguin 4" = "4", 
                                    "Penguin 5" = "5", "Penguin 6" = "6", 
                                    "Penguin 7" = "7", "Penguin 8" = "8", 
                                    "Penguin 9" = "9")) %>%
ggplot(aes(x = duration, y = heartrate, color = bird)) + 
  geom_point() + 
  facet_wrap( ~ bird) + 
  theme_bw() + 
  scale_color_manual(values = wesanderson::wes_palette("Zissou1", 9, 
                                                       type = "continuous")[1:9]) +
  labs(x = "Duration (min)", y = "Heart Rate (beats per minute)", color = "Penguin") + 
  theme(legend.position = "none")
```

To model the data, a linear mixed effects model is fit below with heart rate as the response variable. To start, depth and duration are included as fixed main effects in the model, and a random effect for penguin is specified.

```{r}
library(lme4)
penguin_model <- lmer(heartrate ~ depth + duration + (1|bird), data = penguins)
```

The summary of the model is shown below.

```{r}
summary(penguin_model)
```

Linear mixed effects models have four assumptions that need to be checked. 

1. Independence of observations
2. Linearity between the response variable and the predictor variables
3. Constant variance of the residuals
4. Normality of the residuals

The first assumption can only be checked by considering the study design. In our case, there is a dependence between observations taken from the same penguin, and we already accounted for this by including a random effect for penguin in the model. The other assumptions can be checked by looking at residual plots. ggResidpanel makes it possible to easily create a panel with diagnostic plots that lets us check these assumptions by simply applying the function `resid_panel` to the model. The code and resulting panel of plots are shown below. 

The default panel includes four plots. 

- The plot in the upper left of the panel is a plot of the residuals versus predictived values from the model. This plot can be used to assess the linearity and constant variance assumptions. The curving trend suggests a violation of the lineary assumption, and there appears to be a violation of the constant variance since the variance of the residuals is getting larger as the predicted values increase.

- The plot in the upper right is a normal quantile plot. There appears to be a deviation from normality in the upper end of the residuals, but this is not as much of a concern as linearity and constant variance issues.

- The plot in the lower right of the panel is a histogram of the residuals with a normal density overlayed. This plot is an additional way to check the normality assumption from a different view. This plot makes it clear that there is a slight right skew in the data.

- The plot in the lower left of the panel is a plot of the residuals versus the observation number of the observation. This plot can help to find trends related to the way that the data has been ordered, which may provide insights into additional trends that have not been accounted for in the data. There is not obvious trend in this plot.

```{r}
resid_panel(penguin_model)
```

To further assess the issues with this model, it may be helpful to look at plots of the residuals versus the predictor variables in the model. This can be done easily by applying the function `resid_xpanel` to the model. The code and resulting panel of plots is shown below.

The function creates a panel with a plot included for each predictor variable in the model. In this case, three plots are created for the variables of depth, duration, and bird. Pearson residuals are plotted on the y-axis for each of the plots. These plots show a clear decrease in variation of the residuals as the value of depth increases and the nonlinear relationship is related to the variable of duration. The plot of residuals versus bird shows no obvious trend and relatively constant variance across the penguins.

```{r}
resid_xpanel(penguin_model)
```

The function `resid_xpanel` has the option to plot the response variable on the y-axis by setting `yvar = "response"`. The updated code and resulting panel of plots is shown below.

```{r}
resid_xpanel(penguin_model, yvar = "response")
```

```{r}
penguin_model2 <- lmer(heartrate ~ depth + duration + I(duration^2) + (1|bird), 
                       data = penguins)
penguin_model3 <- lmer(log(heartrate) ~ depth + duration + (1|bird), 
                       data = penguins)
penguin_model4 <- lmer(log(heartrate) ~ depth + duration + I(duration^2) + (1|bird), 
                       data = penguins)
```

```{r fig.width = 7}
resid_compare(models = list(penguin_model, penguin_model2, 
                            penguin_model3, penguin_model4),
              plots = c("resid", "qq"),
              smoother = TRUE,
              qqbands = TRUE)
```

## Board Game Example


